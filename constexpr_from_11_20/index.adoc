= CONSTEXPR ä» 11 åˆ° 20
:customcss: ../presentation.css
:revealjsdir: ../node_modules/reveal.js
:revealjs_plugins: ../presentation_plugins.js
:revealjs_plugins_configuration: ../presentation_plugins_conf.js
:revealjs_theme: serif
:highlightjs-theme: https://cdn.jsdelivr.net/npm/highlight.js@10.2.1/styles/github-gist.css
:source-highlighter: highlightjs
:highlightjs-languages: cpp,x86asm
:revealjs_history: true
:revealjs_pdfseparatefragments: false
:revealjs_transition: slide
:revealjs_slideNumber: c/t
:revealjs_fragmentInURL: true
:icons: font
:stem:
Netcan {docdate} @Shanghai

[subtitle]#constexpr auto ğŸ˜€#

template metaprogramming is dead +
long live constexpr

include::../common/self_introduction.adoc[]

== è®®ç¨‹
* ç¼–è¯‘æ—¶è®¡ç®—ï¼ˆå…ƒç¼–ç¨‹ï¼‰
* æ¼”è¿›å†å²
* constexpr vs æ¨¡æ¿å…ƒ
* é¢å¤–èƒ½åŠ›
* åº”ç”¨
* å±•æœ›æœªæ¥
* ç»“è®º

== ç¼–è¯‘æ—¶è®¡ç®—ï¼ˆå…ƒç¼–ç¨‹ï¼‰
* é›¶æˆæœ¬æŠ½è±¡
* ç¼–è¯‘æ—¶å¤šæ€ (eg. Policy class, Tag Dispatcher, CRTP)
* å€¼è®¡ç®—
* ç±»å‹å®‰å…¨ (eg. å•ä½è¿ç®—, Phantom Types)
* Domain specific languages

=== ç¼–è¯‘æ—¶è®¡ç®—ï¼ˆå…ƒç¼–ç¨‹ï¼‰& æµæ´¾
* æ¨¡æ¿å…ƒç¼–ç¨‹
* Constexpr all the things!
* ä¸¤è€…ç»“åˆ

[.columns]
== æ¼”è¿›å†å²
[.column]
--
æ¨¡æ¿å…ƒç¼–ç¨‹

* 1986 C++å¼•å…¥æ¨¡æ¿
* C++98 æ¨¡æ¿å®ä¾‹åŒ–
* C++11 æ¨¡æ¿ç±»åˆ«åã€å¯å˜æ¨¡æ¿å‚æ•°ã€static_assertã€decltypeã€type_traits
* C++14 å¸¸é‡æ¨¡æ¿ã€decltype(auto)ã€integer_sequence
* C++17 æŠ˜å è¡¨è¾¾å¼ã€CTADã€autoéç±»å‹å‚æ•°ã€void_t
* C++20 Conceptã€lambdaæ¨¡æ¿å‚æ•°ã€æ”¾å®½éç±»å‹å‚æ•°
--

[.column]
--
constexpr

* C++11 å¼•å…¥constexprç®€å•å‡½æ•°
* C++14 æ”¾å¼€constexprçº¦æŸ, æ¨¡æ¿å˜é‡
* C++17 if constexprã€constexpr lambdaã€fold expression
* C++20 constexprå®¹å™¨ã€constexpr newã€constexpr destructorã€constexpr virtualã€consteval/constinit
* constexpr STL algorithms
--

[.columns]
== constexpr vs æ¨¡æ¿å…ƒç¼–ç¨‹
[.column]
--
BrainFuckè¯­è¨€

* å›¾çµå®Œå¤‡
* 8ç§æ“ä½œç¬¦
* DSL

https://fatiherikli.github.io/brainfuck-visualizer/#PisrKysrKysrWzwrKysrKysrKys+LV08LiAgICAgICAgICAgICAgICAgOyBICj4+KysrKysrKysrK1s8KysrKysrKysrKz4tXTwrLiAgICAgICAgICAgIDsgZQo+PisrKysrKysrK1s8KysrKysrKysrKysrPi1dPC4gICAgICAgICAgICA7IGwKPj4rKysrKysrKytbPCsrKysrKysrKysrKz4tXTwuICAgICAgICAgICAgOyBsCj4+KysrKysrKysrK1s8KysrKysrKysrKys+LV08Ky4gICAgICAgICAgIDsgbwo+PisrKytbPCsrKysrKysrPi1dPC4gICAgICAgICAgICAgICAgICAgICA7Cj4+KysrKysrKysrKytbPCsrKysrKysrPi1dPC0uICAgICAgICAgICAgIDsgVwo+PisrKysrKysrKytbPCsrKysrKysrKysrPi1dPCsuICAgICAgICAgICA7IG8KPj4rKysrKysrKysrWzwrKysrKysrKysrKys+LV08LS0tLS0tLiAgICAgOyByCj4+KysrKysrKysrWzwrKysrKysrKysrKys+LV08LiAgICAgICAgICAgIDsgbAo+PisrKysrKysrKytbPCsrKysrKysrKys+LV08LiAgICAgICAgICAgICA7IGQKPj4rKysrKytbPCsrKysrKz4tXTwtLS0uICAgIC[brainfuck-visualizer]
--

[.column]
--
[cols="2"]
|===
| > |	++ptr;
| < |	--ptr;
| + |	++*ptr;
| - |	--*ptr;
| . |	putchar(*ptr);
| , |	*ptr = getchar();
| [ |	while (*ptr) {
| ] |	}

|===
--

=== BrainFuck: Hello world
[source,cpp]
----
puts( R"(
    >++++++++[<+++++++++>-]<.             ; H   (8*9     = 72)
    >>++++++++++[<++++++++++>-]<+.        ; e   (10*10+1 = 101)
    >>+++++++++[<++++++++++++>-]<.        ; l   (9*12    = 108)
    >>+++++++++[<++++++++++++>-]<.        ; l   (9*12    = 108)
    >>++++++++++[<+++++++++++>-]<+.       ; o   (10*11+1 = 111)
    >>++++[<++++++++>-]<.                 ; ' ' (4*8     = 32)
    >>+++++++++++[<++++++++>-]<-.         ; W   (11*8-1  = 87)
    >>++++++++++[<+++++++++++>-]<+.       ; o   (10*11+1 = 111)
    >>++++++++++[<++++++++++++>-]<------. ; r   (10*12-6 = 114)
    >>+++++++++[<++++++++++++>-]<.        ; l   (9*12    = 108)
    >>++++++++++[<++++++++++>-]<.         ; d   (10*10   = 100)
    >>++++++[<++++++>-]<---.              ; !   (6*6-3   = 33)
)"_brain_fuck );
----

== BrainFuckç¼–è¯‘å™¨ï¼šæ¨¡æ¿å…ƒè§£æ³•
Full code: https://godbolt.org/z/GTKxhc[https://godbolt.org/z/GTKxhc]

åŸºç¡€å…ƒæ•°æ®ç»“æ„
[source,cpp]
----
template<char c>
using Cell = std::integral_constant<char, c>;

template<size_t P = 0, bool INLOOP = false, typename ...Cells>
struct Machine {
    using type = Machine<P, INLOOP, Cells...>;
    constexpr static size_t InLoop = INLOOP;
};
----

=== BrainFuckç¼–è¯‘å™¨ï¼šæ¨¡æ¿å…ƒè§£æ³•
Full code: https://godbolt.org/z/GTKxhc[https://godbolt.org/z/GTKxhc]

ç›¸å…³æ“ä½œ
[source,cpp,subs="verbatim,quotes"]
----
namespace MachineTrait {
    template<size_t N>
    struct *InitMachine*: Concat_t<Machine<0, 0, Cell<0>>, typename *InitMachine<N-1>*::type> {};
    template<> struct *InitMachine<0>: Machine<0, 0, Cell<0>>* {};

    template<typename MACHINE> struct Inc;
    template<typename MACHINE> using Inc_t = typename Inc<MACHINE>::type;
    template<size_t PC, bool INLOOP, typename C, typename... Cells>
    struct Inc<Machine<PC, INLOOP, C, Cells...>>:
        Concat_t<Machine<PC, INLOOP, C>, Inc_t<Machine<PC - 1, INLOOP, Cells...>>> {};
    template<bool INLOOP, typename C, typename... Cells>
    struct Inc<Machine<0, INLOOP, C, Cells...>>:
        Machine<0, INLOOP, Cell< *C::value + 1* >, Cells...> {};

    template<typename MACHINE>
    struct Left;
    template<typename MACHINE>
    using Left_t = typename Left<MACHINE>::type;
    template<size_t PC, bool INLOOP, typename... Cells>
    struct Left<Machine<PC, INLOOP, Cells...>>:
        Machine< *PC-1*, INLOOP, Cells...> {};
};
----

=== BrainFuckç¼–è¯‘å™¨ï¼šæ¨¡æ¿å…ƒè§£æ³•
Full code: https://godbolt.org/z/GTKxhc[https://godbolt.org/z/GTKxhc]

è§£æBrainFuckä»£ç ï¼šåŸºæœ¬æ“ä½œ
[source,cpp,subs="verbatim,quotes"]
----
template<typename MACHINE, bool skip, char ...cs>
struct BrainFuck: MACHINE {};
template<typename MACHINE, bool skip, char ...cs>
using BrainFuck_t = typename BrainFuck<MACHINE, skip, cs...>::type;

template<typename MACHINE, char ...cs>
struct BrainFuck<MACHINE, false, *'+'*, cs...>:
    BrainFuck_t<MachineTrait::Inc_t<MACHINE>, false, cs...> {};

template<typename MACHINE, char ...cs>
struct BrainFuck<MACHINE, false, *'-'*, cs...>:
    BrainFuck_t<MachineTrait::Dec_t<MACHINE>, false, cs...> {};

template<typename MACHINE, char ...cs>
struct BrainFuck<MACHINE, false, *'<'*, cs...>:
    BrainFuck_t<MachineTrait::Left_t<MACHINE>, false, cs...> {};

template<typename MACHINE, char ...cs>
struct BrainFuck<MACHINE, false, *'>'*, cs...>:
    BrainFuck_t<MachineTrait::Right_t<MACHINE>, false, cs...> {};
----

=== BrainFuckç¼–è¯‘å™¨ï¼šæ¨¡æ¿å…ƒè§£æ³•
Full code: https://godbolt.org/z/GTKxhc[https://godbolt.org/z/GTKxhc]

è§£æBrainFuckä»£ç ï¼šå¾ªç¯ & åˆ†æ”¯
[source,cpp,subs="verbatim,quotes"]
----
template<typename MACHINE, char ...cs>
struct BrainFuck<MACHINE, false, *'['*, cs...> {
    using EnableLoopedMachine = MachineTrait::EnableLoop_t<MACHINE>;

    template<typename IN, bool = MachineTrait::IsZero_t<IN>::value>
    struct Select: BrainFuck_t<IN, true, cs...> {}; // skip
    template<typename IN> // loop
    struct Select<IN, false>: BrainFuck_t<IN, false, cs...> {};

    using Result = typename Select<EnableLoopedMachine>::type;

    template<typename IN, bool = (! MachineTrait::IsZero_t<IN>::value && IN::InLoop)>
    struct Loop: IN {};   // skip
    template<typename IN> // continue
    struct Loop<IN, true>: BrainFuck_t<IN, false, '[', cs...> {};

    using type = typename Loop<Result>::type;
};
----

=== BrainFuckç¼–è¯‘å™¨ï¼šæ¨¡æ¿å…ƒè§£æ³•
Full code: https://godbolt.org/z/GTKxhc[https://godbolt.org/z/GTKxhc]

ä¿å­˜ç»“æœ
[source,cpp]
----
template<size_t PC, bool INLOOP, typename ...Cells>
inline const auto ToStr(Machine<PC, INLOOP, Cells...>) {
    constexpr const static char str[] = { Cells::value ...  };
    return str;
}

template<typename T, T... cs>
constexpr auto operator ""_brain_fuck() {
    using Machine = MachineTrait::InitMachine_t<15>;
    using Result = BrainFuck_t<Machine, false, cs...>;

    return ToStr(Result{});
};
----

=== BrainFuckç¼–è¯‘å™¨ï¼šæ¨¡æ¿å…ƒè§£æ³•
Full code: https://godbolt.org/z/GTKxhc[https://godbolt.org/z/GTKxhc]

ç”Ÿæˆä»£ç 
[source,x86asm,subs="verbatim,quotes"]
----
main:
    subq    $8, %rsp
    movl    $MachineTrait::ToStr<...>(Machine<...>)::str, %edi
    call    puts
    xorl    %eax, %eax
    addq    $8, %rsp
    ret
MachineTrait::ToStr<...>(Machine<...>)::str:
    .string *"Hello World!"*
    .string ""
    .string ""
    .string ""
----

== BrainFuckç¼–è¯‘å™¨ï¼šconstexprè§£æ³•
Full code: https://godbolt.org/z/EYn7PG[https://godbolt.org/z/EYn7PG]

åŸºç¡€æ•°æ®ç»“æ„
[source,cpp]
----
template<size_t N>
class Stream {
public:
    constexpr void push(char c) { data_[idx_++] = c; }
    constexpr operator const char*() const { return data_; }
    constexpr size_t size() { return idx_; }
private:
    size_t idx_{};
    char data_[N]{};
};
----

=== BrainFuckç¼–è¯‘å™¨ï¼šconstexprè§£æ³•
Full code: https://godbolt.org/z/EYn7PG[https://godbolt.org/z/EYn7PG]

è§£æå™¨
[source,cpp]
----
template<typename STREAM>
constexpr auto parse(const char* input, bool skip, char* cells,
        size_t& pc, STREAM&& output) -> size_t {
    const char* c = input;
    while(*c) {
        switch(*c) {
            case '+': if (!skip) ++cells[pc];            break;
            case '-': if (!skip) --cells[pc];            break;
            case '.': if (!skip) output.push(cells[pc]); break;
            case '>': if (!skip) ++pc;                   break;
            case '<': if (!skip) --pc;                   break;
            case '[': {
                while (!skip && cells[pc] != 0)
                    parse(c + 1, false, cells, pc, std::forward<STREAM>(output));
                c += parse(c + 1, true, cells, pc, std::forward<STREAM>(output)) + 1;
            } break;
            case ']': return c - input;
            default: break;
        }
        ++c;
    }
    return c - input;
}
----

=== BrainFuckç¼–è¯‘å™¨ï¼šconstexprè§£æ³•
Full code: https://godbolt.org/z/EYn7PG[https://godbolt.org/z/EYn7PG]

æ•´åˆä¸€èµ·ï¼š
[source,cpp]
----
constexpr size_t CELL_SIZE = 16;
template<typename STREAM>
constexpr auto parse(const char* input, STREAM&& output) -> STREAM&& {
    char cells[CELL_SIZE]{};
    size_t pc{};
    parse(input, false, cells, pc, output);
    return std::forward<STREAM>(output);
}

template<size_t OUTPUT_SIZE = 15>
constexpr auto brain_fuck(const char* input) {
    return parse(input, Stream<OUTPUT_SIZE>{});
}
----

=== BrainFuckç¼–è¯‘å™¨ï¼šconstexprè§£æ³•
Full code: https://godbolt.org/z/EYn7PG[https://godbolt.org/z/EYn7PG]

ç¼–è¯‘ã€è¿è¡Œæ—¶ä½¿ç”¨ï¼š
[source,cpp]
----
// compile time
constexpr auto res = brain_fuck(R"(
    ++++++++[>++++[>++>+++>+++>+<<<<-]>+>+>->>+[<]<-]>>.
    >---.+++++++..+++.>>.<-.<.+++.------.--------.>>+.>++.
)");
puts(res);

// runtime
if (argc > 1) puts(brain_fuck(argv[1]));
----

=== BrainFuckç¼–è¯‘å™¨ï¼šconstexprè§£æ³•
[source,cpp,subs="verbatim,quotes"]
----
template<size_t *OUTPUT_SIZE* = 15>
constexpr auto brain_fuck(const char* input);
----

icon:question[role="orange"]
è‹¥OUTPUT_SIZEè¿‡å°ï¼Œä¼šæ€ä¹ˆæ ·

image::brain_fuck_buffer_overflow.png[]

icon:lightbulb-o[]
ç¼–è¯‘æŠ¥é”™ï¼Œ*ä¸å…è®¸å†…å­˜è¶Šç•Œub*

=== BrainFuckç¼–è¯‘å™¨ï¼šconstexprè§£æ³•
[source,cpp,subs="verbatim,quotes"]
----
template<size_t *OUTPUT_SIZE* = 15>
constexpr auto brain_fuck(const char* input);
----

icon:question[role="orange"]
å¦‚ä½•æå‰çŸ¥é“OUTPUT_SIZEæ‰€éœ€è¦å¤§å°

[source,cpp,subs="verbatim,quotes"]
----
// calculate output size
constexpr auto *brain_fuck_output_size*(const char* input) -> size_t {
    struct {
        size_t sz{};
        constexpr void push(...) { ++sz; }
    } dummy;
    return parse(input, dummy).sz + 1; // include '\0'
}

#define BRAIN_FUCK(in) brain_fuck< *brain_fuck_output_size(in)* >(in)
constexpr auto res = BRAIN_FUCK(R"(
    ++++++++[>++++[>++>+++>+++>+<<<<-]>+>+>->>+[<]<-]>>.
    >---.+++++++..+++.>>.<-.<.+++.------.--------.>>+.>++.
)");
----

== constexpr vs æ¨¡æ¿å…ƒç¼–ç¨‹
icon:question[role="orange"]
ç¼–è¯‘æ—¶é—´

image::brain_fuck_perf.png[]

0.13s vs 4.088s ! 30x speed up icon:angle-double-up[role="red"]

=== constexpr vs æ¨¡æ¿å…ƒç¼–ç¨‹
æ¨¡æ¿å…ƒ http://redd.it/jnz5p1[http://redd.it/jnz5p1]

* Looks both *scary* and *exciting* at the same time. :P
* After reading this code I gotta *remove C++* from the programming languages I know list.  Sweet mother of god this is *incredible*! :,)
* C++ templates is a language within a language, now you have brainf*ck in templates, so it's a language withing a language within a language. It's languageception.
* Nice, definitely *scary* stuff though.
* Where does one learn to use templates like that? I have no idea what I'm looking at
* Lots of mind altering drugs
* From my experience, templates like this are *hard to casually read* even if you are the one who wrote them. It makes perfect sense when you are *creating the monstrosity* though.
* Actually, for what it is, it's incredibly *readable*.
* Awesome, Now make a c++ compiler with brainfuck :p
* I've been planning on trying something similar with Ruby, to see if the C++ compiler can generate a minimal program.

=== constexpr vs æ¨¡æ¿å…ƒç¼–ç¨‹
æ¨¡æ¿å…ƒ https://zhuanlan.zhihu.com/p/273805962[https://zhuanlan.zhihu.com/p/273805962], https://www.zhihu.com/question/334884938/answer/1557544809[https://www.zhihu.com/question/334884938]

* å¹´è½»äººï¼Œæ²¡è§è¯†è¿‡é¢å‘è„‘å®¹é‡ç¼–ç¨‹å§
* é«˜çº§è¯­è¨€æ¯”æ±‡ç¼–è¿˜éš¾è¯»
* ä½ æ˜¯é­”é¬¼å—
* å¥½èªæ˜çš„ç¼–è¯‘å™¨
* æœºå™¨è¿›åŒ–æˆäººäº†ï¼Œç®€ç§°äººè‚‰ç¼–è¯‘å™¨...
* ä¸è‡³äºä¸è‡³äº
* æ®è¯´å†™BrainFuckä¼šæ„Ÿè§‰brainè¢«fuckäº†â€¦

=== constexpr vs æ¨¡æ¿å…ƒç¼–ç¨‹
constexpr http://redd.it/jp7k0u[http://redd.it/jp7k0u]

* Amazing, very neat, show the *power* of constexpr functions, way more *readable* than template.
* Wow. Your constexpr code is vastly more *readable* than the template metaprogramming one.

[.columns]
=== constexpr vs æ¨¡æ¿å…ƒç¼–ç¨‹
[.column]
--
ç®€å•è®¾è®¡ï¼šæ¨¡æ¿å…ƒ

* é€šè¿‡æ‰€æœ‰æµ‹è¯•(static_assert) icon:check-circle[role="green"]
* æ²¡æœ‰é‡å¤ï¼Œæ˜“äºé‡ç”¨ icon:check-circle[role="green"]
* è¡¨è¾¾æ„å›¾ï¼Œæ˜“äºç†è§£ï¼ˆ~200 linesï¼‰ icon:times[role="red"]
* æ²¡æœ‰å†—ä½™ï¼Œé¿å…è¿‡åº¦è®¾è®¡ icon:ellipsis-h[role="orange"]
--

[.column]
--
ç®€å•è®¾è®¡ï¼šconstexpr

* é€šè¿‡æ‰€æœ‰æµ‹è¯•(static_assert, no ub) icon:check-circle[role="green"]
* æ²¡æœ‰é‡å¤ï¼Œæ˜“äºé‡ç”¨ icon:check-circle[role="green"]
* è¡¨è¾¾æ„å›¾ï¼Œæ˜“äºç†è§£ï¼ˆ~80 linesï¼‰ icon:check-circle[role="green"]
* æ²¡æœ‰å†—ä½™ï¼Œé¿å…è¿‡åº¦è®¾è®¡ icon:check-circle[role="green"]
--

[.columns]
=== constexpr vs æ¨¡æ¿å…ƒç¼–ç¨‹
[.column]
--
æ¨¡æ¿å…ƒä¼˜åŠ¿

* ä½“ç³»æˆç†Ÿï¼Œå‚è€ƒèµ„æ–™å¤š
* æ‹¥æœ‰å¤§é‡çš„åº“
* TypeListå¯ä»¥ä»»æ„æ‰©å®¹
--

[.column]
--
constexpråŠ£åŠ¿

* æ–°å…´åŠ¿åŠ›ï¼Œå‚è€ƒèµ„æ–™å°‘ï¼Œå¾…æŒ–æ˜
* ç”Ÿæ€å¾…å®Œå–„
* C++20ä¹‹å‰éœ€è¦æå‰è®¡ç®—å®¹å™¨å¤§å°
--

[%conceal]
== Constexpr all the things!
image::constexpr-all-the-things.png[80%,80%]


== Reference
* http://odinthenerd.blogspot.com/2014/07/introduction-to-c-metaprogramming-part-1.html[Introduction to C++ Metaprogramming]

